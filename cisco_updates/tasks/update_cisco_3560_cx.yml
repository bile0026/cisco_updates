---
- name: Update TFTP Blocksize to optimize IOS transfer
  cisco.ios.ios_config:
    commands:
      - "ip tftp blocksize {{ tftp_blocksize }}"

- name: Copy 3560CX Image // This could take up to {{ ios_copy_timeout }} seconds
  # ansible.netcommon.net_put:
  #   src: "ios_files/{{ ios_file_3560_cx }}"
  #   dest: "flash:{{ ios_file_3560_cx }}"
  cisco.ios.ios_command:
    commands:
      - command: "copy tftp://{{ tftp_server }}/{{ ios_file_3560_cx }} flash:{{ ios_file_3560_cx }}"
        # prompt: "Destination filename [{{ ios_file_3560_cx }}]?"
        prompt:
          - "]?"
          - "[confirm]"
        answer:
          - "\r"
          - "\r"
  vars:
    ansible_command_timeout: "{{ ios_copy_timeout }}"

- name: Change Boot Variable to new image
  cisco.ios.ios_config:
    commands:
      - "boot system flash:{{ ios_file_3560_cx }}"
    save_when: always

- name: reboot ios device
  cli_command:
    command: reload
    prompt:
      - Save?
      - confirm
    answer:
      - y
      - y

  # check_mode: True
- name: reset the connection
  meta: reset_connection

- name: Wait for the network device to reload
  wait_for_connection:
    delay: "{{ ios_reboot_timeout }}"

- name: Gather facts post reboot
  cisco.ios.ios_facts:
    gather_subset: min

- name: Assert that ios is the correct version
  assert:
    that:
      - ansible_net_version == {{ ios_version }}
  ignore_errors: True
